name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      
      - name: Install dependencies
        run: |
          uv pip install --system ruff
      
      - name: Run Ruff
        run: |
          ruff check cadhy/
          ruff format --check cadhy/

  validate:
    name: Validate Structure
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Validate addon structure
        run: |
          python -c "
          import ast
          from pathlib import Path
          
          # Check all Python files are valid syntax
          errors = []
          for py_file in Path('cadhy').rglob('*.py'):
              try:
                  with open(py_file) as f:
                      ast.parse(f.read())
              except SyntaxError as e:
                  errors.append(f'{py_file}: {e}')
          
          if errors:
              print('Syntax errors found:')
              for e in errors:
                  print(f'  {e}')
              exit(1)
          
          print('✓ All Python files have valid syntax')
          "
      
      - name: Check bl_info
        run: |
          python -c "
          import re
          
          with open('cadhy/__init__.py') as f:
              content = f.read()
          
          # Check bl_info exists
          if 'bl_info' not in content:
              print('ERROR: bl_info not found in __init__.py')
              exit(1)
          
          # Check required bl_info fields
          required = ['name', 'version', 'blender', 'category']
          for field in required:
              if f'\"{field}\"' not in content:
                  print(f'ERROR: {field} not found in bl_info')
                  exit(1)
          
          print('✓ bl_info is valid')
          "

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, validate]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build addon
        run: |
          python scripts/build.py --output dist/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cadhy-addon
          path: dist/*.zip
          retention-days: 7
